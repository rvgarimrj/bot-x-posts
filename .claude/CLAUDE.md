<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# Bot-X-Posts - Regras e Configuracoes

## Visao Geral

Bot automatizado para postar no X (Twitter) via Puppeteer conectado ao Chrome em modo debug. Gera posts bilingues (EN + PT-BR) sobre crypto, investing, AI e vibeCoding usando curadoria multi-fonte + Claude.

## Arquitetura V2

Cron (8h-23h) -> Curate-V3 (multi-fonte paralelo, cache 30min/4h) -> Claude-V2 (analise + geracao bilingue, 8 styles x 8 hooks) -> Media Fetch (Reddit meme + X quote tweet) -> Telegram Preview (2min) -> Puppeteer Post (60s entre posts, digitacao humanizada)

## Horarios e Topicos (TODOS OS DIAS)

| Horario | Posts | Thread | Topicos | Idioma |
|---------|-------|--------|---------|--------|
| 8h | 4 | - | crypto, investing, ai, vibeCoding | EN |
| 10h | 0 | thread+img | auto (melhor sentimento) | EN |
| 12h | 4 | - | crypto, investing, ai, vibeCoding | PT-BR |
| 16h | 4 | - | crypto, investing, ai, vibeCoding | EN |
| 18h | 0 | thread+img | auto (melhor sentimento) | EN |
| 20h | 4 | - | crypto, investing, ai, vibeCoding | PT-BR |
| 22h | 4 | - | crypto, investing, ai, vibeCoding | EN |

**Total:** 20 posts + 2 threads com imagem/dia = ~30 tweets/dia. Threads as 10h/18h em EN com imagem Gemini. EN-heavy: 12 posts EN + 8 posts PT-BR.

**Ciclos extras:** 00:01 Health Check | 23:59 Daily Learning

> **Nota:** Reply Monitor DESATIVADO. Foco: posts + analytics + metas.

## Arquivos Principais

### V2
| Arquivo | Funcao |
|---------|--------|
| `scripts/cron-daemon-v2.js` | Daemon V2: 9 horarios + heartbeat anti-suspensao |
| `scripts/daemon-wrapper.sh` | Wrapper com caffeinate -i (impede idle sleep) |
| `scripts/auto-post-v2.js` | Fluxo V2: 8 posts + thread com imagem (10h/18h) |
| `scripts/daily-learning.js` | Ciclo de aprendizado diario (23:59) |
| `src/curate-v3.js` | Curadoria multi-fonte com fallback chains |
| `src/claude-v2.js` | Geracao bilingue + Threads + Hook Frameworks |
| `src/image-generator.js` | Gera imagens via Gemini API |
| `src/puppeteer-post.js` | Posta tweets/threads com imagens via Chrome |
| `src/reply-monitor.js` | Monitora e responde comentarios (DESATIVADO) |
| `src/media-downloader.js` | Download de midia (video/image/gif) + Gemini safety check |
| `src/sources/reddit-media.js` | Busca memes virais do Reddit (video/image/gif) |
| `src/sources/x-viral-search.js` | Busca tweets virais no X para quote tweet |
| `src/learning-engine.js` | Analisa performance, ajusta pesos |
| `src/analytics-monitor.js` | Coleta metricas do X Analytics |
| `src/engagement-analyzer.js` | Analisa melhores horarios por regiao |
| `src/sources/` | Modulos de fontes de dados |

### V1 (Legacy)
| Arquivo | Funcao |
|---------|--------|
| `scripts/cron-daemon.js` | Daemon V1: 4 horarios, Seg-Sab |
| `scripts/auto-post.js` | Fluxo V1: 3 posts por horario |
| `src/curate-v2.js` | Curadoria com Twitter API |
| `src/claude.js` | Geracao PT-BR apenas |

### Comum
| Arquivo | Funcao |
|---------|--------|
| `src/puppeteer-post.js` | Posta no X via Chrome debug |
| `src/telegram-v2.js` | Notificacoes Telegram |
| `src/telegram-report.js` | Formatadores de relatorios Telegram |

### Dados
| Arquivo | Funcao |
|---------|--------|
| `data/learnings.json` | Pesos e scores do learning engine |
| `data/GOALS.md` | Metas de monetizacao (5M impressoes, 500 premium, 2000 verified) |
| `data/engagement-hours.json` | Pesos por horario baseado em engagement |
| `logs/daily-reports/` | Relatorios diarios em JSON |

## Fontes de Dados por Topico

- **CRYPTO:** CoinGecko (primary), Reddit r/cryptocurrency (primary), RSS CoinTelegraph/CryptoNews (fallback)
- **INVESTING:** Finnhub (primary), Reddit r/stocks r/wallstreetbets (primary), RSS MarketWatch (fallback)
- **AI:** HuggingFace Hub (primary), Reddit r/MachineLearning r/ChatGPT (primary), arXiv (secondary), RSS TechCrunch (fallback)
- **VIBECODING:** HackerNews (primary), GitHub API (primary), Reddit r/Cursor r/LocalLLaMA (secondary), RSS Dev.to (fallback)

## Configuracoes Criticas

### Chrome Debug Mode
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --disable-background-timer-throttling \
  --disable-backgrounding-occluded-windows \
  --disable-renderer-backgrounding
```

### LaunchAgent (Daemon)
- Arquivo: `~/Library/LaunchAgents/com.botxposts.daemon.plist`
- Node: `/usr/local/bin/node` (SEMPRE caminho absoluto via launchd)
- WorkingDirectory: `/Users/user/AppsCalude/Bot-X-Posts`
- KeepAlive, ProcessType: Interactive, ThrottleInterval: 30s

### Anti-Timeout (Mac Sleep)
- App Nap desativado: `defaults write com.google.Chrome NSAppSleepDisabled -bool YES`
- caffeinate -i via daemon-wrapper.sh
- Heartbeat interno a cada 5min
- Timeouts: 60s page, 120s protocol

## Curadoria v2

### Dados Extraidos do X
`topTweets` (velocidade viral), `trendingHashtags`, `topAuthors` (@user + followers), `topMentions`, `influencers` (pre-definidos por nicho)

### Queries de Busca
```javascript
crypto: 'Bitcoin OR #BTC OR #crypto -filter:retweets'
investing: 'stocks OR #SP500 OR $NVDA OR $TSLA -filter:retweets'
vibeCoding: 'Claude Code OR Cursor AI OR "vibe coding" OR "AI coding" -filter:retweets'
```

### Rate Limits e Cache
Cache fresco 60min, stale 4h fallback. Delay 5s entre buscas. Deteccao rate limit automatica (para 15min).

### Cron Jobs DEVEM:
1. Curadoria busca dados frescos + trending do X
2. Extrair hashtags, autores e mentions dos tweets virais
3. Passar dados para Claude via `formatForPrompt()`
4. Claude gera posts com 1-2 hashtags trending + referencias a contas

## Comandos Uteis

```bash
# V2 - Daemon
npm run start:v2
# Interativo: run(r) learn(l) reply(rp) health(h) schedule(sc) status(s) help(?)

# Testar sources
node scripts/test-source.js coingecko|reddit|finnhub|hackernews|github|huggingface

# Testar curadoria/geracao
node scripts/test-curate-v3.js [crypto]
node scripts/test-generate-v2.js [crypto en]

# Ciclo completo / learning
node scripts/auto-post-v2.js
node scripts/daily-learning.js

# Gerenciamento daemon
tail -f logs/daemon-v2.log
launchctl unload ~/Library/LaunchAgents/com.botxposts.daemon.plist
launchctl load ~/Library/LaunchAgents/com.botxposts.daemon.plist
ps aux | grep -E "(caffeinate|cron-daemon)" | grep -v grep

# Chrome
curl -s http://localhost:9222/json/version

# Learning V2
npm run learn|collect|health|restart|report|goals|learn:dry
```

## Problemas Conhecidos

| Problema | Solucao |
|----------|---------|
| `spawn node ENOENT` | Usar `/usr/local/bin/node` |
| Daemons duplicados | ThrottleInterval + KeepAlive config |
| Telegram 409 Conflict | Garantir apenas 1 daemon |
| Aba X nao encontrada | Codigo abre automaticamente |
| Timeout tela bloqueada | Flags anti-suspensao Chrome + caffeinate |
| Rate limit | Cache 15min + fallback |
| Post truncado | Verificacao 90% + retry clipboard + typeHuman fallback |
| `.catch()` em sync | Usar try/catch para unlinkSync |
| Daemon suspenso (TN) | caffeinate -i + heartbeat + KeepAlive:true |
| Ano errado nos posts (2024) | Prompt agora inclui `TODAY'S DATE` + regra anti-ano-passado |
| Hashtags coladas/duplicadas | Regra no prompt: separar com espaco, sem duplicatas |
| Node is detached (stale ref) | Re-find textbox com `page.$()` antes de cada fallback |
| Modal nao fechou (falso-neg) | `isComposeModalOpen()` verifica `[role="dialog"]` em vez de textarea |
| Post duplicado no X | Detecta "Voce ja disse isso" + flag `possiblyPosted` pula retry |
| Cron perdido (watchdog lento) | Same-hour detection (10min) + grace window 60min |

## Fluxo de Postagem (V2)

1. Cron dispara (8h-23h)
2. `curateContentV3()` busca multi-fonte em paralelo (fallback: Primary->Secondary->RSS)
3. `generatePost()` gera 8 posts (4 topicos x 2 idiomas)
4. Preview Telegram (2min para cancelar)
5. `postTweet()` digita no X como humano (delays variaveis), 60s entre posts

## Diferenciacao EN vs PT-BR

- **EN:** Global dev perspective, #AI #VibeCoding #ClaudeCode, tecnico/direto
- **PT-BR:** @garim prompt original, #DevBR #ClaudeCode, pratico/conversacional
- Mesma conta @garim, intercalados. NAO sao traducoes - Claude gera independentemente.

## Sistema de Variedade: Styles + Hook Frameworks

8 POST_STYLES: `hot_take`, `observation`, `question`, `reaction`, `tip`, `sarcasm`, `personal`, `contrarian`
8 HOOK_FRAMEWORKS: `extreme`, `aida`, `pas`, `bab`, `emotional`, `results`, `client`, `idea`
**8 x 8 = 64 combinacoes** aleatorias por post. Evita deteccao de bot, parece humano, melhora engagement.

Implementacao em `claude-v2.js` `generatePost()` - selecao aleatoria, inclui no prompt como TONE/STYLE + HOOK FRAMEWORK.

## Sistema de Auto-Aprendizado V2

Aprende quais HOOK + STYLE + TOPIC + HOUR geram mais engajamento. Ajusta pesos dinamicamente.

### Metas (Creator Studio)
- **Partilha de Receitas:** 5M impressoes + 500 premium em 90 dias (~55k/dia)
- **Subscricoes:** 5M impressoes + 2,000 verified em 90 dias

### Ciclo: Posts com pesos -> 23:59 coleta metricas -> analise Claude -> ajuste pesos -> 00:05 daemon restart -> proximos posts com novos pesos

### Dimensoes de Aprendizado
Hooks, Styles, Topics, Hours, Experiments - cada com weight (0.3-2.0), uses, totalEngagement

### Formula
```javascript
newWeight = currentWeight * (1 + (engagementRate - avgEngagement) * 0.1) // LEARNING_RATE=0.1
// MIN_WEIGHT=0.3, MAX_WEIGHT=2.0
```

### Arquivos: `src/engagement-analyzer.js`, `src/telegram-report.js`, `scripts/daily-learning.js`, `scripts/daemon-manager.js`, `data/GOALS.md`, `data/engagement-hours.json`, `data/learnings.json`

## Reply Monitor (DESATIVADO)

Codigo pronto em `src/reply-monitor.js`. Monitora mencoes, classifica comentarios (question/disagreement/agreement/compliment/joke/generic), gera respostas humanizadas com Claude (max 200 chars + emojis). Dados: `data/replies-log.json`, `data/replied-ids.json`.

## Sistema de Threads com Imagens

Threads geram 5-10x mais impressoes. 2/dia as 10h e 18h, em EN, com imagem no 1o tweet.

### Thread Frameworks: `story` (narrativa), `listicle` (lista), `breakdown` (explicacao), `contrarian` (hot take)

### Estrutura: 1/ Hook+imagem -> 2/ Contexto -> 3/ Insight -> 4/ Aplicacao -> 5/ CTA+hashtags

### Fluxo: Verifica horario thread -> curadoria seleciona melhor topico -> Claude gera 5 tweets -> Gemini gera imagem -> Multi-tweet composer (abre, insere, +, repete, posta)

### Config em `auto-post-v2.js`: `THREAD_HOURS=[10,18]`, `THREAD_LANGUAGE='en'`, `THREAD_WITH_IMAGE=true`

### Comandos
```bash
node scripts/test-thread.js [crypto en] [--post]
```

## Sistema de Media Posts (Video Memes + Quote Tweets)

Posts com midia (videos, imagens, GIFs) geram 10-100x mais engagement. 2 media posts por ciclo, substituem 2 posts EN de texto.

### Pipeline A: Reddit Memes
- Busca memes virais de subreddits por topico (ProgrammerHumor, CryptoCurrency, etc.)
- Suporta video, image e GIF
- Filtros: score >= 500, age < 7 days, NSFW check, keyword relevance
- Safety check via Gemini Vision (3 camadas: Reddit over_18, Gemini Vision, Telegram preview)
- Caption gerada por Claude (100-200 chars, witty reaction)
- Download para /tmp/bot-x-media/, max 50MB video / 10MB image
- Cache 30min

### Pipeline B: X Quote Tweets
- Busca tweets virais via Puppeteer search no X
- Queries por topico (min_faves:100-500, filter:media)
- Commentary gerada por Claude (100-200 chars, adds perspective)
- Post via Quote Tweet (URL auto-embeds no composer)
- Zero copyright risk (atribuicao automatica)
- Cache 60min

### Fluxo no auto-post-v2.js
Step 2.7a: fetchRedditMedia() -> downloadMedia() -> checkMediaSafety() -> generateVideoCaption()
Step 2.7b: searchViralTweets() -> generateQuoteComment()
Substitui 2 posts EN de texto -> Telegram preview com indicadores de midia -> postTweetWithVideo()/postQuoteTweet()
Fallback: se midia falha, posta como texto normal

### Comandos
```bash
node scripts/test-video-meme.js              # Dry run: fetch + download + caption
node scripts/test-video-meme.js --post       # Post a real video meme
node scripts/test-video-meme.js --quote      # Test quote tweet flow
node scripts/test-video-meme.js --all        # Test both pipelines
node scripts/test-video-meme.js [topic]      # Specify topic
```

## Geracao de Imagens (Gemini)

- API: Google Gemini, modelo `gemini-2.0-flash-exp-image-generation`
- Resolucao 1024x574 (16:9), gratis, env `GOOGLE_GEMINI_API_KEY`
- Estilos: `cyber` (crypto/AI), `chart` (investing), `modern` (geral), `abstract` (vibeCoding)
- Arquivos: `src/image-generator.js`, salva em `/tmp/bot-x-images/`

## Notas de Desenvolvimento

- Posts max 500 chars
- Digitacao humanizada: 70-130ms entre chars, pausas apos pontuacao
- 60s entre posts, retry 3x conexao Chrome, 2x post
- Cache: 30min fresco, 4h stale

## Premissas e Licoes Aprendidas

### Insercao de Texto no X (3 metodos em cascata)
1. **`execCommand('insertText')`** = rapido, mas insere apenas 30-50% do texto (bug sistematico)
2. **Clipboard via textarea oculto** = `execCommand('copy')` + Cmd+V. Tambem falha ~50% das vezes
3. **`typeHuman()` char por char** = lento mas confiavel. SEMPRE funciona como ultimo fallback
- **CRITICO:** Re-buscar textbox com `page.$()` antes de cada fallback. Cmd+A/Backspace causa React reconciliation que invalida referencias DOM ("Node is detached")
- **Emojis:** usar `for...of` (code points), colar emojis via clipboard. Iteracao por indice quebra surrogate pairs

### Deteccao de Sucesso ao Postar
- **NAO usar** `page.$('[data-testid="tweetTextarea_0"]')` para detectar se modal fechou
- O /home tem inline composer que SEMPRE tem `tweetTextarea_0`
- **Usar** `isComposeModalOpen()` que verifica `[role="dialog"]` contendo textarea
- Detecta aviso de duplicado ("Voce ja disse isso") e retorna `possiblyPosted: true`
- `postWithRetry` pula retry quando `possiblyPosted` para evitar duplicatas no X

### Node.js
- `fs.unlinkSync()` = sync, usar try/catch (NAO .catch())
- Daemon spawn() recarrega codigo do disco - NAO precisa reiniciar para editar scripts
- So reiniciar se editar `cron-daemon-v2.js`

### Verificacao de Posts
Verificacao final exige 90% do texto. Se < 90%, retry via clipboard. Se ainda falha, erro (trigger retry do post inteiro).

## Historico de Commits (Recentes)
- **2026-02-07 20:35** [`832db06`] Reduce posting volume: 72 to 20 posts/day + 2 threads (.claude/CLAUDE.md,scripts/auto-post-v2.js,scripts/cron-daemon-v2.js)
- **2026-02-07 20:35** [`edf3e16`] Add dismissOrphanModal: close stale compose modals before posting (src/puppeteer-post.js)
- **2026-02-07 12:38** [`732d119`] Fix modal detection: check dialog overlay instead of textarea existence (src/puppeteer-post.js)
- **2026-02-07 07:32** [`1b6f29a`] Fix posting failures: stale DOM refs, duplicate detection, watchdog timing (scripts/auto-post-v2.js,scripts/cron-daemon-v2.js,src/puppeteer-post.js)
- **2026-02-06 16:20** [`8fa3613`] Update documentation with media posts and posting fixes (.claude/CLAUDE.md)
- **2026-02-06 16:19** [`d8192c9`] Fix posting failures: robust Post button click + text verification (src/puppeteer-post.js,src/sources/x-viral-search.js)
- **2026-02-06 14:09** [`666cc2b`] Add Media Posts system: Reddit memes + X quote tweets (.claude/CLAUDE.md,scripts/auto-post-v2.js,scripts/test-video-meme.js,src/claude-v2.js,src/media-downloader.js)
- **2026-02-06 12:24** [`cfbe48e`] Update documentation with today's fixes (.claude/CLAUDE.md)
- **2026-02-06** [`269ba13`] Stricter text verification: reject posts <90% + retry clipboard
- **2026-02-06** [`a718ad2`] Fix text truncation undetected + false-positive post success
- **2026-02-06** [`64004d7`] Consolidate Telegram notifications into single summary
- **2026-02-06** [`3abb11e`] Fix wrong year (2024) in posts and duplicate hashtags
- **2026-02-06 09:49** [`dfbadff`] Add watchdog to detect and recover missed cron triggers (scripts/cron-daemon-v2.js)
- `affdda7` Fix emoji rendering (for...of + clipboard)
- `fb7070d` Fix daemon suspension (caffeinate + heartbeat + KeepAlive)
- `9634221` Add Thread System with AI-generated Images (Gemini)
- `9178ea2` Improve posting reliability + disable Reply Monitor
- `dc694f2` Add Reply Monitor
- `4a000b5` Update schedule: post every 2h
- `6c85cc1` Add Self-Learning V2 System with Goals Tracking
- `1ec2efe` Add Hook Frameworks + Self-Learning Analytics
- `3f7b9c5` Fix text truncation: clipboard instead of chunked DOM
- `9f07b6a` Add multi-source bilingual posting system (v2)
